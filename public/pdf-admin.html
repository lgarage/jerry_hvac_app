<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Manual Upload - Jerry HVAC App</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
    }

    .upload-section {
      background: white;
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 12px;
      padding: 48px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8f9fa;
    }

    .upload-area:hover {
      border-color: #764ba2;
      background: #f0f1f3;
    }

    .upload-area.dragging {
      background: #e9ecef;
      border-color: #10b981;
    }

    .upload-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .upload-text {
      font-size: 18px;
      color: #333;
      margin-bottom: 8px;
    }

    .upload-hint {
      font-size: 14px;
      color: #666;
    }

    input[type="file"] {
      display: none;
    }

    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 16px;
    }

    .btn:hover {
      background: #764ba2;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .manuals-section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .manual-card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s;
    }

    .manual-card:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .manual-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .manual-title {
      font-weight: 600;
      color: #333;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-processing {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-completed {
      background: #d1fae5;
      color: #065f46;
    }

    .status-failed {
      background: #fee2e2;
      color: #991b1b;
    }

    .manual-info {
      font-size: 14px;
      color: #666;
      margin-bottom: 4px;
    }

    .manual-stats {
      display: flex;
      gap: 24px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e0e0e0;
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #666;
    }

    .stat strong {
      color: #333;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      margin-top: 12px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.show {
      display: block;
    }

    .toast.success {
      border-left: 4px solid #10b981;
    }

    .toast.error {
      border-left: 4px solid #ef4444;
    }

    .empty-state {
      text-align: center;
      padding: 48px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìö HVAC Manual Upload</h1>
      <p class="subtitle">Upload PDF manuals to automatically extract terminology and parts</p>
    </header>

    <div class="upload-section">
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìÑ</div>
        <div class="upload-text">Click to upload or drag and drop</div>
        <div class="upload-hint">PDF files only ‚Ä¢ Maximum 50MB</div>
        <input type="file" id="fileInput" accept=".pdf" />
      </div>
      <button class="btn" id="uploadBtn" style="display: none;">Upload PDF</button>
    </div>

    <div class="manuals-section">
      <h2 style="margin-bottom: 16px;">üìã Uploaded Manuals</h2>
      <div id="manualsList"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const manualsList = document.getElementById('manualsList');
    const toast = document.getElementById('toast');

    let selectedFile = null;

    // Click to upload
    uploadArea.addEventListener('click', () => fileInput.click());

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragging');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragging');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragging');

      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].type === 'application/pdf') {
        fileInput.files = files;
        handleFileSelect();
      } else {
        showToast('Please select a PDF file', 'error');
      }
    });

    // File selection
    fileInput.addEventListener('change', handleFileSelect);

    function handleFileSelect() {
      selectedFile = fileInput.files[0];
      if (selectedFile) {
        const sizeMB = (selectedFile.size / 1024 / 1024).toFixed(2);
        uploadArea.innerHTML = `
          <div class="upload-icon">‚úÖ</div>
          <div class="upload-text">${selectedFile.name}</div>
          <div class="upload-hint">${sizeMB} MB ‚Ä¢ Click to change</div>
        `;
        uploadBtn.style.display = 'block';
      }
    }

    // Upload button
    uploadBtn.addEventListener('click', async () => {
      if (!selectedFile) return;

      const formData = new FormData();
      formData.append('pdf', selectedFile);

      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Uploading...';

      try {
        const response = await fetch('/api/manuals/upload', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          showToast('‚úÖ PDF uploaded! Processing started...', 'success');
          resetUploadArea();
          loadManuals();
        } else {
          showToast('‚ùå Upload failed: ' + result.error, 'error');
        }
      } catch (error) {
        showToast('‚ùå Upload failed: ' + error.message, 'error');
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload PDF';
      }
    });

    // Load manuals list
    async function loadManuals() {
      try {
        const response = await fetch('/api/manuals');
        const data = await response.json();

        if (data.manuals.length === 0) {
          manualsList.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <div>No manuals uploaded yet</div>
            </div>
          `;
          return;
        }

        manualsList.innerHTML = data.manuals.map(manual => `
          <div class="manual-card">
            <div class="manual-header">
              <div class="manual-title">${manual.original_filename}</div>
              <div class="status-badge status-${manual.status}">${manual.status.toUpperCase()}</div>
            </div>
            <div class="manual-info">
              üìÖ Uploaded: ${new Date(manual.uploaded_at).toLocaleString()}
            </div>
            ${manual.page_count ? `<div class="manual-info">üìÑ Pages: ${manual.page_count}</div>` : ''}
            ${manual.file_size ? `<div class="manual-info">üì¶ Size: ${(manual.file_size / 1024 / 1024).toFixed(2)} MB</div>` : ''}
            ${manual.status === 'processing' ? '<div class="progress-bar"><div class="progress-fill" style="width: 50%;"></div></div>' : ''}
            ${manual.error_message ? `<div class="manual-info" style="color: #dc2626;">‚ùå ${manual.error_message}</div>` : ''}
            <div class="manual-actions" style="margin-top: 12px; display: flex; gap: 8px;">
              ${manual.status === 'failed' ? `<button onclick="retryManual(${manual.id})" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">üîÑ Retry</button>` : ''}
              <button onclick="deleteManual(${manual.id})" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">üóëÔ∏è Delete</button>
            </div>
          </div>
        `).join('');

        // Poll for updates if any are processing
        const hasProcessing = data.manuals.some(m => m.status === 'processing' || m.status === 'pending');
        if (hasProcessing) {
          setTimeout(loadManuals, 5000);
        }

      } catch (error) {
        console.error('Error loading manuals:', error);
      }
    }

    function resetUploadArea() {
      selectedFile = null;
      fileInput.value = '';
      uploadArea.innerHTML = `
        <div class="upload-icon">üìÑ</div>
        <div class="upload-text">Click to upload or drag and drop</div>
        <div class="upload-hint">PDF files only ‚Ä¢ Maximum 50MB</div>
      `;
      uploadBtn.style.display = 'none';
    }

    function showToast(message, type) {
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Delete manual
    async function deleteManual(manualId) {
      if (!confirm('Are you sure you want to delete this manual? This cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`/api/manuals/${manualId}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          showToast('‚úÖ Manual deleted successfully', 'success');
          loadManuals(); // Refresh the list
        } else {
          showToast('‚ùå Failed to delete manual', 'error');
        }
      } catch (error) {
        console.error('Error deleting manual:', error);
        showToast('‚ùå Error deleting manual', 'error');
      }
    }

    // Retry failed manual
    async function retryManual(manualId) {
      try {
        const response = await fetch(`/api/manuals/${manualId}/retry`, {
          method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
          showToast('üîÑ Processing restarted...', 'success');
          loadManuals(); // Refresh the list
        } else {
          showToast(`‚ùå ${result.error || 'Failed to retry'}`, 'error');
        }
      } catch (error) {
        console.error('Error retrying manual:', error);
        showToast('‚ùå Error retrying manual', 'error');
      }
    }

    // Initial load
    loadManuals();
  </script>
</body>
</html>
